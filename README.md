[![GitHub release (latest SemVer)](https://img.shields.io/github/v/release/dis-works/diswall)](https://github.com/dis-works/diswall/releases/latest) [![CodeQL](https://github.com/dis-works/diswall/actions/workflows/codeql-analysis.yml/badge.svg)](https://github.com/dis-works/diswall/actions/workflows/codeql-analysis.yml) [![Go Report Card](https://goreportcard.com/badge/github.com/dis-works/diswall)](https://goreportcard.com/report/github.com/dis-works/diswall)

- [Описание](#diswall-альфа-версия)
- [ipset](#ipset)
- [NATS](#nats)
- [Опции](#опции)
- [Установка своего сервера](#установка-своего-сервера)
- [Автономная работа](#автономная-работа)
- [Сбор данных](#сбор-данных)

# diswall (альфа-версия!)

diswall (distributed firewall) - клиент распределённого сетевого фильтра работающий на множестве серверов и использующий [NATS](https://nats.io) в качестве транспорта. Его цель - максимально быстрая блокировка IP на всех защищаемых серверах при его обращении на закрытый порт любого из этих серверов. Таким образом diswall обеспечивает защиту от сканирования всей инфраструктуры (анти-shodan) не давая злоумышленнику возможности собрать информацию о системе.

В качестве источника "плохих" адресов используется запись пакетов в iptables. Однако в будущем возможно использовать и другие источники (например журналы WAF). Благодаря использованию шаблонов rsyslog из сообщений ядра выбирается только IP, другая информация из журналов никак не используется и никуда не отправляется. Каждый обнаруженный IP заносится в чёрный список при помощи ipset и возможное открытое соединение с ним обрывается (что бы предотвратить нежелательную активность с открытыми портами, например эксплуатацию веб-уязвимости). Одновременно с этим при помощи NATS IP посылается на центральный сервер (https://diswall.stream) откуда передаётся всем клиентам diswall'а.

Аналогичным образом имеется возможность распространять белые списки, для удобства настройки сетевого фильтра на серверах. В отличие от чёрного списка - белый для каждого клиента является уникальным, поддерживает комментарии и добавление целых подсетей.

Каждый добавленный в чёрный список IP хранится в течение суток, а в белом списке - без ограничений по времени. Имеется возможность удалить адрес из любого списка.

При загрузке сервера - клиент diswall получает текущие актуальные копии чёрных и белых списков. Это позволяет обеспечить защищённость с учётом событий произошедших на других серверах пока текущий был в отключённом состоянии.

# ipset

diswall использует два списка ipset - для заблокированных и разрешённых адресов. Имена по-умолчанию - `diswall-bl` и `diswall-wl` соответственно. Белый список создаётся командой `ipset create -exist diswall-wl hash:net comment`. Он позволяет добавлять записи подсетями и использовать комментарии. Чёрный список создаётся командой `ipset create -exist diswall-bl hash:ip hashsize 32768 maxelem 1000000 timeout 86400`. Он позволяет добавлять только по 1 IP и не поддерживает комментарии. Срок жизни записи в чёрном списке ограничен 1 сутками. Максимальное кол-во записей в чёрном списке - 1 000 000, в белом - 65 536.

# NATS

По-умолчанию используются следующие темы для публикации IP, однако клиент diswall'а позволяет задавать свои:
- diswall.whitelist.<имя_клиента> - для добавления адреса в белый список;
- diswall.whitelist.<имя_клиента>.del - для удаления адреса из белого списка;
- diswall.blacklist - для добавления адреса в чёрный список;
- diswall.blacklist.del - для удаления адреса из чёрного списка.

Кроме того имеются две специальные темы - `diswall.blacklist.init` и `diswall.whitelist.init`. Они использутся для начальной инициализации списков при старте системы.

Клиент diswall'а можно использовать и для отправки сообщений вручную, например для удаления адреса из чёрного списка, либо добавления в белый. В последнем случае к записи можно добавить комментарий - он объединяются с данными через `|`.

# Опции

Конфигурация хранится в `/etc/diswall.toml`. Кроме того могут использоваться параметры командной строки. Большинство из них может переопределить значение из конфигурационного файла, но имеется несколько уникальных.

| Параметр командной строки | Соответствие в конф. файле | Описание | Значение по-умолчанию |
| - | - | - | - |
| -pipe | pipePath | путь к именованному каналу, куда rsyslog записывает IP от iptables | "/var/log/diswall/diswall.pipe" |
| -server | server | адрес центрального сервера diswall | "diswall.stream" |
| -port | port | порт центрального сервера diswall | 4222 |
| -name | clientName | имя пользователя для подключения | — |
| -password | clientPass | пароль пользователя для подключения | — |
| -localonly | localonly | работать автономно, без подключения к серверу | false |
| -wl-ipset | wlIpset | имя списка ipset для разрешённых IP | "diswall-wl" |
| -bl-ipset | blIpset | имя списка ipset для блокируемых IP | "diswall-bl" |
| -wl-subj | wlAddSubj | тема для публикации добавляемых в БС IP | —* |
| -bl-subj | blAddSubj | тема для публикации добавляемых в ЧС IP | "diswall.blacklist" |
| -wl-del-subj | wlDelSubj | тема для публикации удаляемых из БС IP | —* |
| -bl-del-subj | blDelSubj | тема для публикации удаляемых из ЧС IP | "diswall.blacklist.del" |
| -wl-add-ip** | — | добавить указанный IP в БС | — |
| -wl-add-comm** | — | опциональный комментарий ipset для добавляемого в БС IP | — |
| -wl-del-ip** | — | удалить указанный IP из БС | — |
| -bl-del-ip** | — | удалить указанный IP из ЧС | — |

\* Если эти параметры не заданы, то их значение генерируется автоматически на основе имени клиента.

\*\* Если заданы эти параметры, то diswall только публикует данные и завершает работу. Все сообщения при этом идут только в STDOUT, файл журнала не используется. Опции могут быть заданы вместе, но каждой может быть передан лишь 1 адрес.

# Установка своего сервера

Для того что бы использовать свой сервер diswall'а, необходимо установить NATS и скрипт для отдачи списков IP серверам при их загрузке. Инструкция с различными вариантами установки NATS'а есть в официальной [документации](https://docs.nats.io/nats-server/installation). После установки требуется настроить права доступа: пример приведён ниже, а полное руководство - в [документации](https://docs.nats.io/nats-server/configuration/securing_nats/authorization):

```
$ cat /etc/nats.conf
...
authorization {
  default_permissions = {
    subscribe = ["diswall.blacklist.init", "diswall.blacklist"]
  }
  DW_INIT = {
    publish = "_INBOX.>"
    subscribe = ["diswall.blacklist.init", "diswall.whitelist.init"]
  }
  MY_NET = {
    publish = ["diswall.blacklist.init", "diswall.whitelist.init", "diswall.blacklist", "diswall.whitelist.my_net", "diswall.blacklist.del", "diswall.whitelist.my_net.del"]
    subscribe = ["_INBOX.>", "diswall.blacklist", "diswall.whitelist.my_net", "diswall.blacklist.del", "diswall.whitelist.my_net.del"]
  }
  users = [
    {user: dw_init,   password: "QuodLicetJovi",   permissions: $DW_INIT}
    {user: my_net,  password: "NonLicetBovi",   permissions: $MY_NET}
  ]
}
```

Пароль пользователя dw_init и имя сервера нужно задать в скрипте [diswall-init.go](diswall-init/diswall-init.go), после чего скомпилировать командой `go build diswall-init.go` и обеспечить автозагрузку полученного файла. Этот скрипт позволяет из различных имеющихся белых списков выбрать тот, который относится к обратившемуся клиенту, основываясь на его имени. Соответственно, для примера выше, необходимо создать белый список с именем `diswall-wl-my_net`: `ipset create -exist diswall-wl-my_net hash:net comment`.

# Автономная работа

Клиент diswall'а может работать и локально, без подключения к серверам. Этот режим работы активируется параметром `localonly`. В таком случае diswall будет по-прежнему блокировать IP основываясь на журнале iptables, но не будет устанавливать соединение с сервером и, следовательно, передавать/принимать данные.

# Сбор данных

При добавлении IP в чёрный список отправляется имя узла который передал адрес, эта информация доступна всем клиентам.
