# DisWall documentation

<!-- TOC -->
* [How it works](#how-it-works)
   * [Simplified iptables+ipset configuration](#simplified-iptablesipset-configuration)
   * [Distributed part](#distributed-part)
* [Getting started](#getting-started)
   * [Dependencies](#dependencies)
   * [Installation](#installation)
   * [Configuration](#configuration)
* [Options and features](#options-and-features)
   * [Config options](#config-options)
   * [Commandline options](#commandline-options)
* [Motivation](#motivation)
<!-- TOC -->

## How it works

Main functionality - the IPs blocking mechanism, works with help of iptables and ipset. You need to install them on your server before you begin.
What is iptables? It is a firewall that can check all network packets for some criteria and to do some actions with them.
What is ipset? It is an extension to iptables, that adds an ability to work with big lists of networks or IPs.
So, iptables can check any packet against a big list and do something if some IP belongs to the list or not.

### Simplified iptables+ipset configuration

`iptables` is configured to allow local and established connections as well as connections from explicitly defined IPs and/or networks.
Then, it is configured to block anything that is added to an ipset list `diswall-bl`.
After that it allows connections to explicitly defined ports (services).
And (the remainder) if some connection (or UDP datagram) is trying to get to some other port it is logged to syslog with well-defined tag.
After that rsyslog takes only source IP from that logged packet and writes it to a pipe (`/var/log/diswall/diswall/pipe`), and DisWall reads it and blocks it by adding it to ipset list.
Rsyslog is configured by a config file `/etc/rsyslog.d/10-diswall.conf`, it is added to your system during installation.

Full configuration is done in `/usr/bin/diswall_init.sh`, and you MUST check this file after diswall installation.
This file is run by a service `diswall-fw-init` before starting of `diswall` service itself.

### Distributed part

DisWall itself would be a very simplistic app and would not get to its goal - to ban most of the port-scanning bots out there if it would not have network layer.
Every DisWall can connect to our NATS-server to be able to get new banned IPs from our special honeypots.

Just register on [diswall.stream](https://diswall.stream), confirm your e-mail, enter credentials to `/etc/diswall/diswall.conf` file and restart the service.
Your local diswall will constantly get new IPs to block on a constant basis. If some our honeypot blocks an IP it will get to you in a matter of milliseconds.

## Getting started

### Dependencies

First of all you will need some dependencies to be installed.
1. Install iptables and ipset (`sudo apt install iptables ipset`). And if you have some other firewall (`ufw` or `firewalld`) uninstall it.
2. If you want to use quick-install script from our site - make sure you have jq installed (`sudo install jq`).

### Installation

Use `curl https://get.diswall.stream | bash` or `wget -O - https://get.diswall.stream | bash` to install the DisWall.

### Configuration

1. If you want to use full-fledged DisWall then you need to register on [diswall.stream](https://diswall.stream), confirm e-mail and copy credentials from our mail to `/etc/diswall/diswall.conf`.

2. This step maybe is most important. Open `/usr/bin/diswall_init.sh` with your preferred text editor and check all autogenerated rules for iptables that are in this file.
   You can add some other rules to allow all connections from your home or office IPs no matter what to be sure that if something goes wrong you can connect to your server via SSH and correct things.

Only after these steps you can enable and start diswall service (`sudo systemctl enable --now diswall`).

## Options and features

### Config options

You can change default ipset lists names from `diswall-bl` and `diswall-wl` to anything you want. Just don't forget to change them in `/usr/bin/diswall_init.sh` too.

You can disable online functionality by changing `local_only` to false. But it is not recommended as the main purpose of DisWall is to provide distributed operation.

NATS configuration, and in particular `client_name` and `client_pass` should be familiar to you already - these you fill up when you register on DisWall website and install it on your server.

You can also change `hostname` of your server in communication with NATS-server. It doesn't need to be the same as your true hostname.

If you don't want to send statistics about how many IPs did you block and how many packets/bytes was dropped or accepted by your server, then you can disable sending stats to our server by changing `send_statistics` to false.

### Commandline options

All commandline parameters you can see if you run `diswall -h`, but here they are:

```
-h, --help                Print this help menu
-v, --version             Print version and exit
    --install             Install DisWall as system service (in client mode)
    --update              Update DisWall to latest release from GitHub
    --uninstall           Uninstall DisWall from your server
-d, --debug               Show trace messages, more than debug
-g, --generate            Generate fresh configuration file. It is better to redirect contents to file.
-c, --config FILE         Set configuration file path
    --log FILE            Set log file path
-f, --pipe-file FILE      Named pipe from which to fetch IPs
-s, --nats-server DOMAIN  NATS server name
-P, --port PORT           NATS server port
-n, --name NAME           NATS client name (login)
-p, --pass PASSWORD       NATS password
-l, --local-only          Don't connect to NATS server, work only locally
-a, --allow-list          Allow list name
-b, --block-list          Block list name
    --wl-add-ip IP        Add this IP to allow list
    --wl-add-comm COMMENT Comment to add with IP to allow list
    --wl-del-ip IP        Remove IP from allow list
    --bl-add-ip IP        Add this IP to block list
    --bl-del-ip IP        Remove IP from block list
-k, --kill                Kill already established connection using `ss -K`
    --server              Start diswall NATS server to handle init messages.
```

## Motivation

Imagine, that someone is going from town to town and from home to home and takes accurate info about every door lock, and then this person is publishing all info on the Internet.
This situation is horrible in real life, but in server administration world it is a common thing, and almost no one thinks about a defence against this kind of activity.

Port scans are indeed a common thing, we block about 1500 IPs that are scanning our honeypots in an hour. And almost any hacker attack start from port scan to determine all services that are open to an intruder.

And the main goal of DisWall is to protect servers from this type of hostile activity. And we think that we've done a great job.

